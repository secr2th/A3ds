/**
 * í…Œë§ˆ ë³€í˜•
 * - ì»¬ëŸ¬ í…Œë§ˆë³„ CSS ë³€ìˆ˜ ì˜¤ë²„ë¼ì´ë“œ
 */

/* Blue Theme */
[data-color="blue"] {
  --color-primary: #3b82f6;
  --color-primary-dark: #2563eb;
  --color-primary-light: #60a5fa;
}

/* Purple Theme */
[data-color="purple"] {
  --color-primary: #a855f7;
  --color-primary-dark: #9333ea;
  --color-primary-light: #c084fc;
}

/* Pink Theme */
[data-color="pink"] {
  --color-primary: #ec4899;
  --color-primary-dark: #db2777;
  --color-primary-light: #f472b6;
}

/* Green Theme */
[data-color="green"] {
  --color-primary: #10b981;
  --color-primary-dark: #059669;
  --color-primary-light: #34d399;
}

/* Orange Theme */
[data-color="orange"] {
  --color-primary: #f59e0b;
  --color-primary-dark: #d97706;
  --color-primary-light: #fbbf24;
}

/* Indigo Theme (ê¸°ë³¸ê°’) */
[data-color="indigo"] {
  --color-primary: #6366f1;
  --color-primary-dark: #4f46e5;
  --color-primary-light: #818cf8;
}

  /**
   * CSS ì½”ë“œë¡œ ì»¤ìŠ¤í…€ í°íŠ¸ ì¶”ê°€
   */
  async addCustomFontFromCSS() {
    const cssInput = document.getElementById('custom-font-css');
    const nameInput = document.getElementById('custom-font-name');

    if (!cssInput || !nameInput) return;

    const cssCode = cssInput.value.trim();
    const fontName = nameInput.value.trim();

    if (!cssCode || !fontName) {
      window.app.toast.show('CSS ì½”ë“œì™€ í°íŠ¸ëª…ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
      return;
    }

    // CSS ìœ íš¨ì„± ê°„ë‹¨ ì²´í¬
    if (!cssCode.includes('@font-face') || !cssCode.includes('font-family')) {
      window.app.toast.show('ì˜¬ë°”ë¥¸ @font-face ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤', 'error');
      return;
    }

    // ì´ë¯¸ ì¶”ê°€ëœ í°íŠ¸ì¸ì§€ ì²´í¬
    if (this.customFonts.some(f => f.name === fontName)) {
      window.app.toast.show('ì´ë¯¸ ì¶”ê°€ëœ í°íŠ¸ì˜ˆìš”', 'warning');
      return;
    }

    try {
      // CSSë¥¼ <style> íƒœê·¸ë¡œ ì¶”ê°€
      const style = document.createElement('style');
      style.id = `custom-font-${fontName.replace(/\s+/g, '-')}`;
      style.textContent = cssCode;
      document.head.appendChild(style);

      // í°íŠ¸ ë¡œë“œ í…ŒìŠ¤íŠ¸
      await document.fonts.load(`16px "${fontName}"`);

      // ì»¤ìŠ¤í…€ í°íŠ¸ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
      this.customFonts.push({
        name: fontName,
        css: cssCode,
        styleId: style.id
      });

      this.saveThemeSettings();
      this.updateFontSelect();
      this.updateCustomFontsList();

      cssInput.value = '';
      nameInput.value = '';

      window.app.toast.show(`âœ… ${fontName} í°íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆì–´ìš”!`, 'success');

    } catch (error) {
      console.error('Font load error:', error);
      window.app.toast.show('í°íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì–´ìš”', 'error');
    }
  }

  /**
   * ì»¤ìŠ¤í…€ í°íŠ¸ ì‚­ì œ
   */
  removeCustomFont(fontName) {
    if (confirm(`${fontName} í°íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ì–´ìš”?`)) {
      const fontData = this.customFonts.find(f => f.name === fontName);
      if (fontData) {
        // <style> íƒœê·¸ ì œê±°
        const style = document.getElementById(fontData.styleId);
        if (style) style.remove();

        // ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°
        this.customFonts = this.customFonts.filter(f => f.name !== fontName);

        // í˜„ì¬ ì‚¬ìš© ì¤‘ì´ë©´ ê¸°ë³¸ í°íŠ¸ë¡œ ë³€ê²½
        if (this.currentFont === fontName) {
          this.currentFont = 'Pretendard';
          this.applyFont();
        }

        this.saveThemeSettings();
        this.updateFontSelect();
        this.updateCustomFontsList();

        window.app.toast.show(`${fontName} í°íŠ¸ê°€ ì‚­ì œë˜ì—ˆì–´ìš”`, 'success');
      }
    }
  }

  /**
   * ì»¤ìŠ¤í…€ í°íŠ¸ ë¦¬ìŠ¤íŠ¸ UI ì—…ë°ì´íŠ¸
   */
  updateCustomFontsList() {
    const container = document.getElementById('custom-fonts-list');
    if (!container) return;

    if (this.customFonts.length === 0) {
      container.innerHTML = '<small style="color: var(--text-secondary);">ë“±ë¡ëœ ì»¤ìŠ¤í…€ í°íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</small>';
      return;
    }

    container.innerHTML = this.customFonts.map(font => `
      <div style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 8px;
      ">
        <span style="font-family: '${font.name}', sans-serif; font-weight: 600;">
          ${font.name}
        </span>
        <button class="btn-danger"
                onclick="app.theme.removeCustomFont('${font.name}')"
                style="padding: 4px 12px; font-size: 12px;">
          ì‚­ì œ
        </button>
      </div>
    `).join('');
  }

  /**
   * ì´ˆê¸°í™” ì‹œ ì €ì¥ëœ ì»¤ìŠ¤í…€ í°íŠ¸ ë¡œë“œ
   */
  init() {
    const settings = storage.getSettings();

    if (settings.theme) {
      this.currentColor = settings.theme.color || 'indigo';
      this.currentMode = settings.theme.mode || 'auto';
      this.currentFont = settings.theme.font || 'Pretendard';
      this.customFonts = settings.theme.customFonts || [];
    }

    // ğŸ‘‡ ì €ì¥ëœ ì»¤ìŠ¤í…€ í°íŠ¸ë“¤ ë‹¤ì‹œ ë¡œë“œ
    this.customFonts.forEach(font => {
      const style = document.createElement('style');
      style.id = font.styleId;
      style.textContent = font.css;
      document.head.appendChild(style);
    });

    this.applyTheme();
    this.applyFont();
    this.updateUI();

    if (window.matchMedia) {
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        if (this.currentMode === 'auto') this.applyTheme();
      });
    }
  }

        updateFontSelect() {
    const select = document.getElementById('font-select');
    if (!select) return;

    const defaultFonts = ['Pretendard', 'Noto Sans KR', 'Nanum Gothic', 'Nanum Myeongjo'];

    // ğŸ‘‡ customFontsëŠ” ì´ì œ ê°ì²´ ë°°ì—´ì´ë¯€ë¡œ .mapìœ¼ë¡œ ì´ë¦„ ì¶”ì¶œ
    const customFontNames = this.customFonts.map(f => f.name);
    const allFonts = [...defaultFonts, ...customFontNames];

    select.innerHTML = allFonts.map(font =>
      `<option value="${font}" ${font === this.currentFont ? 'selected' : ''}>
        ${font}${customFontNames.includes(font) ? ' (ì»¤ìŠ¤í…€)' : ''}
      </option>`
    ).join('');
  }

  updateUI() {
    // ì»¬ëŸ¬ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ
    document.querySelectorAll('.color-btn').forEach(btn => {
      const color = btn.getAttribute('data-color');
      btn.classList.toggle('active', color === this.currentColor);
    });

    // ëª¨ë“œ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ
    document.querySelectorAll('.mode-btn').forEach(btn => {
      const mode = btn.getAttribute('data-mode');
      btn.classList.toggle('active', mode === this.currentMode);
    });

    this.updateFontSelect();
    this.updateCustomFontsList(); // ğŸ‘ˆ ì¶”ê°€
  }

